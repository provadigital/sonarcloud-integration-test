name: '[QE] SonarCloud'

on:

  # Trigger when the master is updated
  push:
    branches:
    - master
    - main
   
  # Trigger on label approval
  # You MUST analyze the code before
#   pull_request_target:
#     branches:
#     - master
#     - main
#     types:
#     - labeled

  pull_request:
    branches:
    - master
    - main

jobs:

  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    # If the event is from pull_request_target, must have a label
    # This is important to avoid been hacked
    # DANGER: never add the label whitout check the GitHub Action code!!!
    
#     if: ${{ github.event_name == 'push' ||
#             ( 
#               github.event_name == 'pull_request_target' &&
#               contains(github.event.label.name, 'safe to test')
#             )
#          }}
    
    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"
      
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
        ref: ${{ github.event.pull_request.head.sha }}
        
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      with:
          # SonarCloud doesn't treat pull_request_target, so we need this
          args: -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
